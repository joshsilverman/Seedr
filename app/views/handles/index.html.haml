- model_class = Handle
.page-header
  %h1= t '.title', :default => model_class.model_name.human.pluralize
%table.table.table-striped
  %thead
    %tr
      %th 
      %th= model_class.human_attribute_name(:name)
      %th Count
      %th Grade
      %th= t '.actions', :default => t("helpers.actions")
  %tbody
    - question_count = {:published => 0, :total => 0}
    - percentages = []
    - cis = []

    - @handles.each_with_index do |handle, i|
      - published_count = handle.decks.map{|d| d.cards}.flatten.select{|c| c.publish == true}.count
      - total = handle.decks.map{|d| d.cards}.flatten.count
      - question_count[:published] += published_count
      - question_count[:total] += total
      - percentages << @grades[handle.id][:percentage] if @grades[handle.id][:percentage]
      - cis << @grades[handle.id][:ci] if @grades[handle.id][:ci]
      
      %tr
        %td= i + 1
        %td= link_to handle.name, edit_handle_path(handle)
        %td
          = published_count
          \/
          = total
        %td
          = sprintf("%.f", @grades[handle.id][:percentage] * 100) if @grades[handle.id][:percentage]
          = " (+/- #{sprintf "%.f", @grades[handle.id][:ci] * 100})" if @grades[handle.id][:ci]
        %td
          = link_to "Export", "/handles/#{handle.id}/export.json"
          &nbsp;|&nbsp;
          = link_to t('.destroy', :default => t("helpers.links.destroy")),                                 
            handle_path(handle),                                                                           
            :method => :delete,                                                                            
            :confirm => t('.confirm', :default => t("helpers.links.confirm", :default => 'Are you sure?'))
          &nbsp;|&nbsp;
          = link_to "Audit", "/handles/#{handle.id}/audit"
    %tr.well
      %td
      %td 
        %strong= "#{@handles.count} handles"
      %td
        %strong= "#{question_count[:published]}/#{question_count[:total]}"
      %td
        %strong= "#{sprintf("%.f", percentages.sum/percentages.count * 100)}% (+/- #{sprintf("%.f", cis.sum/cis.count * 100)})"
      %td
= link_to t('.new', :default => t("helpers.links.new")), new_handle_path, :class => 'btn btn-primary'